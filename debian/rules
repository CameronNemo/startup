#!/usr/bin/make -f

DEB_BUILD_MAINT_OPTIONS  := hardening=+pie,+bindnow
DEB_LDFLAGS_MAINT_APPEND := -Wl,--as-needed
DEB_CFLAGS_MAINT_APPEND  := -Wall

# Disable optimisations if noopt found in $DEB_BUILD_OPTIONS
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	DEB_LDFLAGS_MAINT_APPEND += -Wl,-O0
else
	DEB_CFLAGS_MAINT_APPEND += -Os
	DEB_LDFLAGS_MAINT_APPEND += -Wl,-O1
endif

export DEB_BUILD_MAINT_OPTIONS DEB_LDFLAGS_MAINT_APPEND DEB_CFLAGS_MAINT_APPEND

%:
	dh $@ --with bash-completion,autoreconf,python3

override_dh_auto_configure:
	dh_auto_configure -- --exec-prefix= --disable-silent-rules --disable-abi-check

override_dh_auto_build:
	dh_auto_build --parallel

override_dh_auto_test:
ifeq (0,$(shell id -u))
	# WARNING: RUNNING TESTS AS ROOT IS KNOWN TO FAIL
	# WARNING: WILL RUN TESTS, BUT WILL IGNORE FAILURE
	-dh_auto_build -- check
else
	# debhelper regression from http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=713257
	dh_auto_build -- check
endif

override_dh_fixperms:
	dh_fixperms
	chmod 755 debian/upstart/lib/init/upstart-job
	chmod 755 debian/upstart/lib/init/apparmor-profile-load
	chmod 755 debian/upstart/usr/lib/upstart/migrate-inittab.pl
	rm debian/upstart/etc/init/upstart-event-bridge.conf

override_dh_install:
	dh_install
	for i in \
		net-device-added \
		net-device-removed \
		graphics-device-added \
		drm-device-added; do \
		rm debian/tmp/usr/share/man/man7/$$i.7; \
	done
	install -m 644 debian/upstart.apport \
		debian/upstart/usr/share/apport/package-hooks/upstart.py

# Remove this man page for the upstart package; it will be added to the
# upstart-monitor package by its .manpages file, but removing it here is
# simpler than specifying every other section 8 manpage in the upstart
# packages .manpages file.
override_dh_installman:
	dh_installman
	rm debian/upstart/usr/share/man/man8/upstart-monitor.8*
