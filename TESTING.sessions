.. contents::

=============================
Testing Sessions with Upstart
=============================

Upstart now has support for chroots which are implemented by creating a
separate session for every user within each chroot. It also has partial
support for user sessions, but since this is experimental (and disabled
in Ubuntu), this document does not cover testing this feature.

The session support does not yet provide full tests (as would be run by
"``make check``"). This is partly due to the complexity of automatically
testing some of the scenarios below.

This document attempts to outline the minimum set of tests that should
be performed to ensure that chroot support works as expected.

Assumptions
===========

You are running an Ubuntu or Debian system.

Setup
=====

#. Install a chroot environement (such as ``schroot(1)``) and configure it.
#. run, "``debootstrap(8)``" to install the same release as you are running into your chroot.
#. Create the following files *outside* your chroot.

   - ``/etc/init/foo.conf``::
     
       start on wibble
       
       script
         exec 2>>/tmp/foo.$$.log
         echo "foo: stat=`stat /`" 
         echo "foo: env=`env`"
         sleep 999 
       end script

   - ``/etc/init/outside_chroot.conf``::

       start on A
          
       script
         exec 2>>/tmp/outside_chroot.$$.log
         echo "in_chroot: stat=`stat /`" 
         echo "in_chroot: env=`env`"
         sleep 999 
       end script

#. Create following files inside chroot environment.

   - ``/path/to/chroot/etc/init/foo.conf``::

       start on wibble
          
       script
         exec 2>>/tmp/foo.$$.log
         echo "foo: stat=`stat /`" 
         echo "foo: env=`env`" 
         sleep 999
       end script

   - ``/path/to/chroot/etc/init/in_chroot.conf``::

       start on A
        
       script
         exec 2>>/tmp/in_chroot.$$.log
         echo "in_chroot: stat=`stat /`" 
         echo "in_chroot: env=`env`" 
         sleep 999
       end script

   
Run as non-``root`` with no chroot
==================================

- ``initctl list``

  Ensure list is contents of ``/etc/init/``: the command below should
  return no output::

    cmp <(initctl list|awk '{print }'|sort -u) <(cd /etc/init && ls *.conf|cut -d: -f2-|sed 's/\.conf//g'|sort -u)

- ``initctl status cron``

  Should work.

- ``initctl show-config cron``

  Should work.

- ``initctl check-config``

  Should work.

- ``start foo``

  Should fail ("``initctl: Rejected send message``").

- ``stop cron``

   Should fail ("``initctl: Rejected send message``").

- ``restart cron``

  Should fail ("``initctl: Rejected send message``").

- ``initctl emit bar``

  Should fail ("``initctl: Rejected send message``").

Run as ``root`` with no chroot
==============================

- ``initctl list``

  Ensure list is contents of ``/etc/init/``: command below should return no output::

    cmp <(initctl list|awk '{print }'|sort -u) <(cd /etc/init && ls *.conf|cut -d: -f2-|sed 's/\.conf//g'|sort -u)

- ``initctl status outside_chroot``

  Should work.

- ``initctl status in_chroot``

  Should fail with message::

    initct: Unknown job: in_chroot

- ``initctl show-config <job>``

- ``initctl check-config <job>``

- ``start in_chroot``

  Should fail with message::

    initct: Unknown job: in_chroot

- ``start outside_chroot``

   Should work.

- ``stop in_chroot``

   Should fail with message::

    initct: Unknown job: in_chroot

- ``restart outside_chroot``

   Sould work.

- ``stop outside_chroot``

   Should work.

- ``initctl emit wibble``

  - Ensure ``/etc/init/foo.conf`` runs by looking at the log and ensuring
    the inode for the stat of '``/``' is the same as running "``stat /``" on
    the command-line.

  * Ensure ``/path/to/chroot/etc/init/foo.conf`` does *NOT* run.

- ``initctl emit A``

  - Ensure ``/etc/init/outside_chroot.conf`` runs.

  - Ensure ``/path/to/chroot/etc/init/in_chroot.conf`` does *NOT* run.

Run as ``root`` inside a chroot
===============================

- ``initctl list``

  Ensure list is contents of ``/path/to/chroot/etc/init/``: command below should return no output::

    cmp <(initctl list|awk '{print }'|sort -u) <(cd /etc/init && ls *.conf|cut -d: -f2-|sed 's/\.conf//g'|sort -u)

- ``initctl status in_chroot``

  Should work.

- ``initctl status outside_chroot``

  Should fail with message::

    initct: Unknown job: outside_chroot

- ``initctl show-config <job>``

- ``initctl check-config <job>``

- ``start outside_chroot``

   Should fail with message::

    initct: Unknown job: outside_chroot

- ``stop outside_chroot``

   Should fail with message::

    initct: Unknown job: outside_chroot

- ``start in_chroot``

   should work.

- ``restart in_chroot``

   Should work.

- ``stop in_chroot``

   Should work.

- ``initctl emit wibble``

  - Ensure ``/path/to/chroot/etc/init/foo.conf`` runs by looking at the log and ensuring
    the inode for the stat of '``/``' is the same as running "``stat /``" on the command-line.

  - Ensure ``/etc/init/foo.conf`` does *NOT* run.

- ``initctl emit A``

  - Ensure ``/path/to/chroot/etc/init/in_chroot.conf`` runs.

  - Ensure ``/etc/init/outside_chroot.conf`` does *NOT* run.

Run as non-root inside a chroot
===============================

Not supported.

Run with ``--no-sessions``
==========================

The "``--no-sessions``" option makes Upstart behave as it used to prior to
the introduction of session support.

#. Reboot system and specify "``--no-sessions``" on kernel command-line.

.. Ensure "``initctl list``" within a chroot displays the same list as
   "``initctl list``" run outside of any chroot environment.

